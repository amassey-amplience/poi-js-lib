!function(t,e){"function"==typeof define&&define.amd?define([],e(t)):"object"==typeof exports?module.exports=e(t):t.atomic=e(t)}("undefined"!=typeof global?global:this.window||this.global,function(t){"use strict";var e,a={},n=!!t.XMLHttpRequest&&!!t.JSON,r={type:"GET",url:null,data:{},callback:null,headers:{"Content-type":"application/x-www-form-urlencoded"},responseType:"text",withCredentials:!1},i=function(){for(var t={},e=0;e<arguments.length;e++){var a=arguments[e];!function(e){for(var a in e)Object.prototype.hasOwnProperty.call(e,a)&&("[object Object]"===Object.prototype.toString.call(e[a])?t[a]=i(!0,t[a],e[a]):t[a]=e[a])}(a)}return t},s=function(t){var a;if("text"!==e.responseType&&""!==e.responseType)return[t.response,t];try{a=JSON.parse(t.responseText)}catch(e){a=t.responseText}return[a,t]},o=function(t){if("string"==typeof t)return t;if(/application\/json/i.test(e.headers["Content-type"])||"[object Array]"===Object.prototype.toString.call(t))return JSON.stringify(t);var a=[];for(var n in t)t.hasOwnProperty(n)&&a.push(encodeURIComponent(n)+"="+encodeURIComponent(t[n]));return a.join("&")},l=function(){var t={success:function(){},error:function(){},always:function(){}},a={success:function(e){return t.success=e,a},error:function(e){return t.error=e,a},always:function(e){return t.always=e,a}},n=new XMLHttpRequest;n.onreadystatechange=function(){if(4===n.readyState){var e=s(n);n.status>=200&&n.status<300?t.success.apply(t,e):t.error.apply(t,e),t.always.apply(t,e)}},n.open(e.type,e.url,!0),n.responseType=e.responseType;for(var r in e.headers)e.headers.hasOwnProperty(r)&&n.setRequestHeader(r,e.headers[r]);return e.withCredentials&&(n.withCredentials=!0),n.send(o(e.data)),a},c=function(){var a=t.document.getElementsByTagName("script")[0],n=t.document.createElement("script");e.data.callback=e.callback,n.src=e.url+(e.url.indexOf("?")+1?"&":"?")+o(e.data),a.parentNode.insertBefore(n,a),n.onload=function(){this.remove()}};return a.ajax=function(t){if(n)return e=i(r,t||{}),"jsonp"===e.type.toLowerCase()?c():l()},a}),window.POI=function(t){this.images=[],this.imgsLoaded=0,this.params=t,this.namedImagesData={},this.namedImages={}},window.POI.prototype={generateData:function(t){var e,a=this,n=a.getHotspots(t.data);if(null!==n){var r=a.findImg(t.img);e={dimensions:{width:t.data.width,height:t.data.height},canvas:t.canvas,changeSize:t.changeSize,layerCommand:t.layerCommand,$img:r,data:t.img,name:t.img.name,points:n,breakpoints:t.breakpoints,svg:null},a.images.push(e),a.namedImagesData[t.img.name+"?"+t.img.query]=e}a.imgsLoaded+=1,t.callback(e)},getImgData:function(t){for(var e=this,a=this.params.images,n=this.getWindowSize(),r=document.querySelectorAll("img."+this.params.imgClass),i=document.getElementsByTagName("source"),s=function(a){var n=a.query||"",r=a.name.includes("?")?"&X-Amp-Trace=true&v="+(new Date).getTime():"?"+n+"&X-Amp-Trace=true&v="+(new Date).getTime();atomic.ajax({url:e.params.domain+"/i/"+e.params.account+"/"+a.name+r}).success(function(r){var i=r.find(function(t){return"translate"===t.type});if(!(i&&i.data&&i.data.output&&i.data.output.layerCommand))return!1;var s,o=i.data.output.layerCommand.metadata,l=i.data.output.layerCommand,c=i.data.output.childlayers,u=i.data.output.layerCommand.info.canvas;s=c.find(function(t){return t.layerCommand.metadata}),s&&s.layerCommand&&(l=s.layerCommand,o=s.layerCommand.metadata,u=s.layerCommand.info.canvas),e.generateData({data:o,layerCommand:l,canvas:u,changeSize:n.includes("crop")||a.name.includes("crop"),img:a,breakpoints:a.breakpoints,callback:function(e){t(e)}})}).error(function(t){console.error("Image failed to load",t)})},o=a.length-1;o>=0;o--)!function(){var l=o,c=a[l];if("*"===c.name)for(var u=r.length-1;u>=0;u--)!function(){var a,n=u,i=c,o=r[n],l=o.getAttribute("src");if(m=l.split("?"),p=m[0].split("/"),p=p[p.length-1],m.length>1&&(a=m[m.length-1]),e.namedImages[p])return!1;var d={name:p,query:a,clearName:p,hotspotCallbacks:i.hotspotCallbacks,polygonCallbacks:i.polygonCallbacks};d&&d.data?e.generateData({data:d.data,img:d,callback:function(e){t(e)}}):d&&e.namedImagesData[d.name+"?"+d.query]?t(e.namedImagesData[d.name+"?"+d.query]):s(d)}();else{var m,p,d=[],g=!1;window.devicePixelRatio>1&&(g=!0);for(var f=i.length-1;f>=0;f--){var h,y,v,b=i[f].getAttribute("srcset"),C=i[f].getAttribute("media"),w=b.split(",");w=w.map(Function.prototype.call,String.prototype.trim),w.forEach(function(t){t.includes("1x")?h=t:t.includes("2x")?y=t:h=t}),g&&y?b=y:h&&(b=h),m=b.split("?"),p=m[0].split("/"),v=m[1]||"",p=p[p.length-1],C=C.split("and"),C=C.map(Function.prototype.call,String.prototype.trim);var S={polygonCallbacks:c.polygonCallbacks,hotspotCallbacks:c.hotspotCallbacks,name:p,query:v};C=C.map(function(t){t=t.replace("(",""),t=t.replace(")",""),t=t.split(":"),t=t.map(Function.prototype.call,String.prototype.trim);var e=t[0]&&"max-width"===t[0]?"maxWidth":"minWidth",a=t[1]?parseInt(t[1].replace("px",""),10):"minWidth"===e?0:"";return S[e]=a,S}),d.push(S)}var k=d.find(function(t){var e=t.minWidth||0,a=t.maxWidth||2e3;return e<=n&&a>=n});if(k)c=k,c.breakpoints=d;else{b=e.findImg(c).getAttribute("srcset"),w=b.split(","),w=w.map(Function.prototype.call,String.prototype.trim),w.forEach(function(t){t.includes("1x")?h=t:t.includes("2x")?y=t:h=t}),g&&y?b=y:h&&(b=h),m=b.split("?"),v=m[1]||"",c.query=v}c&&c.data?e.generateData({data:c.data,layerCommand:c.layerCommand,canvas:c.canvas,changeSize:c.changeSize,img:c,callback:function(e){t(e)}}):c&&e.namedImagesData[c.name+"?"+c.query]?t(e.namedImagesData[c.name+"?"+c.query]):s(c)}}()},findImg:function(t){var e=document.querySelectorAll("img."+this.params.imgClass),a=this.params.imgAttribute||"src",n=null,r=new RegExp(t.clearName||t.name),i=null;"*"===t.name&&(r=/[\s\S]+/g);for(var s=e.length-1;s>=0;s--){var o=e[s].parentNode;if(o&&"picture"===o.tagName.toLowerCase()){for(var l=o.children,c=l.length-1;c>=0;c--)if((i=l[c].getAttribute(a)?l[c].getAttribute(a).match(r):l[c].getAttribute("srcset").match(r))&&i.length>0){n=e[s];break}}else if((i=e[s].getAttribute(a).match(r))&&i.length>0){n=e[s];break}}return n},getHotspots:function(t){var e=null;t.constructor!==Array&&(t=[t]);for(var a=t.length-1;a>=0;a--)t[a]&&t[a].metadata&&t[a].metadata.hotSpots&&t[a].metadata.hotSpots.constructor===Object&&t[a].metadata.hotSpots.hotSpots&&t[a].metadata.hotSpots.hotSpots.constructor===Object&&t[a].metadata.hotSpots.hotSpots.list&&t[a].metadata.hotSpots.hotSpots.list.length>0&&(e=t[a].metadata.hotSpots.hotSpots.list);return e},iteratePoints:function(t){if(t){var e=this.hotspots(),a=this.polygons(),n=t.points;e.removeOthers(t);for(var r=n.length-1;r>=0;r--)a.hideOthers(n[r],t),n[r].points.constructor===Array?a.create(n[r],t):e.create(n[r],t)}},assignEvents:function(t,e,a,n){if(a&&a.length>0)for(var r=a.length-1;r>=0;r--)!function(){var i=a[r];if(i.target===e)t.addEventListener(i.action,function(t){i.callback(t,n)},!1),i.initCallback&&i.initCallback(n);else if("*"===i.target){var s=a.find(function(t){return t.target===e&&t.action===i.action});s||(t.addEventListener(i.action,function(t){i.callback(t,n)},!1),i.initCallback&&i.initCallback(n))}}()},getWindowSize:function(){return document.documentElement.clientWidth},checkResizeSubscription:function(){for(var t,e=this.images,a=!1,n=this,r=e.length-1;r>=0;r--)if(e[r].name&&"*"!==e[r].name&&(n.namedImages[e[r].name]=!0),e[r].breakpoints&&e[r].breakpoints.length){a=!0;break}a&&(window.onresize=function(e){clearTimeout(t),t=setTimeout(function(){n.getImgData(function(t){n.iteratePoints(t)})},350)})},init:function(){var t=this;this.getImgData(function(e){t.iteratePoints(e),t.checkResizeSubscription()})}},"object"==typeof exports&&(module.exports=POI),POI.prototype.dom={hasClass:function(t,e){return new RegExp("(\\s|^)"+e+"(\\s|$)").test(t.className)},getClosest:function(t,e){var a,n,r=e.charAt(0),i="classList"in document.documentElement;for("["===r&&(e=e.substr(1,e.length-2),a=e.split("="),a.length>1&&(n=!0,a[1]=a[1].replace(/"/g,"").replace(/'/g,"")));t&&t!==document&&1===t.nodeType;t=t.parentNode){if("."===r)if(i){if(t.classList.contains(e.substr(1)))return t}else if(new RegExp("(^|\\s)"+e.substr(1)+"(\\s|$)").test(t.className))return t;if("#"===r&&t.id===e.substr(1))return t;if("["===r&&t.hasAttribute(a[0])){if(!n)return t;if(t.getAttribute(a[0])===a[1])return t}if(t.tagName.toLowerCase()===e)return t}return null}},POI.prototype.hotspots=function(){var t=this;return{create:function(e,a){var n=a.data.hotspotCallbacks,r=document.createElement("div"),i=e.selector,s=e.target;if(!i)return void console.warn("no selector specified");0===i.indexOf(".")?(i=i.slice(1),r.setAttribute("class",i)):0===i.indexOf("#")?(i=i.slice(1),r.setAttribute("id",i)):r.setAttribute("class",i);var o=t.dom.getClosest(a.$img,"."+t.params.containerClass);if(r.setAttribute("data-type","poi-hotspot"),o&&t.dom.hasClass(o,t.params.containerClass)){var l,c,u=e.points.x*a.dimensions.width,m=e.points.y*a.dimensions.height,p=a.canvas,d=a.layerCommand,g=d.tileEndW,f=d.tileEndH,h=a.changeSize;if(p){var y=p.x,v=p.y,b=p.width,C=p.height;l=100*(u-y)/b,c=100*(m-v)/C}if(h)l<=100&&c<=100&&(r.style.position="absolute",r.style.left=l+"%",r.style.top=c+"%",r.setAttribute("data-name",a.name),o.style.position="relative",o.appendChild(r));else if(!h){var w,S;w=y?100*(e.points.x*g-y)/b:100*e.points.x,S=v?100*(e.points.y*f-v)/C:100*e.points.y,w<=100&&S<=100&&(r.style.position="absolute",r.style.left=w+"%",r.style.top=S+"%",r.setAttribute("data-name",a.name),o.style.position="relative",o.appendChild(r))}s&&s.length>0&&(r.setAttribute("data-target",s),t.assignEvents(r,s,n,{$image:a.$img,$target:r,$parent:o,hotspot:e,imgInfo:a}))}else console.warn("No parent with specified className "+t.params.containerClass+" was found.")},removeOthers:function(e){var a=t.dom.getClosest(e.$img,"."+t.params.containerClass),n=a&&a.querySelectorAll('[data-type="poi-hotspot"]');if(!n)return!1;for(var r=n.length-1;r>=0;r--)a&&a.removeChild(n[r])}}},POI.prototype.polygons=function(){var t=this;return{create:function(e,a){var n=a.data.polygonCallbacks,r=e.selector;if(!r)return void console.warn("no selector specified");var i,s=e.target,o=t.dom.getClosest(a.$img,"."+t.params.containerClass),l="http://www.w3.org/2000/svg",c=document.createElementNS(l,"g"),u=document.createElementNS(l,"polygon"),m=a.canvas,p=a.layerCommand,d=p.tileEndW,g=p.tileEndH;if(!o)return!1;if(m)var f=m.x,h=m.y,y=m.width,v=m.height;if(a.svg?i=a.svg:(i=document.createElementNS(l,"svg"),i.setAttributeNS(null,"viewBox","0 0 "+(y||a.dimensions.width)+" "+(v||a.dimensions.height)),i.setAttributeNS(null,"data-name",a.name+"?"+a.data.query),o.appendChild(i),a.svg=i),0===r.indexOf(".")?(r=r.slice(1),u.setAttributeNS(null,"class",r)):0===r.indexOf("#")?(r=r.slice(1),u.setAttributeNS(null,"id",r)):u.setAttributeNS(null,"class",r),o&&t.dom.hasClass(o,t.params.containerClass)){var b="";e.points.forEach(function(t,e){var n=a.dimensions.width*t.x,r=a.dimensions.height*t.y;n=d>0?t.x*d-f:Math.abs(f-n),r=g>0?t.y*g-h:Math.abs(h-r),b+=n+","+r+" "}),u.setAttributeNS(null,"points",b),i.appendChild(c),c.appendChild(u),s&&s.length>0&&(u.setAttributeNS(null,"data-target",s),t.assignEvents(c,s,n,{$image:a.$img,$target:c,$parent:o,polygon:e,imgInfo:a}))}else console.warn("No parent with specified className "+t.params.containerClass+" was found.")},hideOthers:function(e,a){var n=t.dom.getClosest(a.$img,"."+t.params.containerClass),r=n&&n.getElementsByTagName("svg");if(!r||!r.length)return!1;for(var i=r.length-1;i>=0;i--)r[i].getAttribute("data-name")===a.name+"?"+a.data.query?r[i].style.display="block":r[i].style.display="none"}}};